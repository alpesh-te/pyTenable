'''
VM Vulnerability API Endpoint Schemas
'''
# from typing import Dict

from marshmallow import Schema, fields

# from marshmallow import validate, validates_schema


class VulnerabilityObjectSchema(Schema):
    tenable_plugin_id = fields.Str()
    cve = fields.Str()
    port = fields.Int()
    protocol = fields.Str()
    authenticated = fields.Bool()
    last_found = fields.Int()
    output = fields.Str()


class NetworkInterfaceObjectSchema(Schema):
    ipv4 = fields.List(fields.Str())
    ipv6 = fields.List(fields.Str())
    mac_address = fields.Str()
    netbios_name = fields.Str()
    fqdn = fields.Str()


class AssetObjectSchema(Schema):
    '''
    Schema to validate Asset object in Payload
    '''
    network_interfaces = fields.List(
        fields.Nested(NetworkInterfaceObjectSchema))
    hostname = fields.Str()
    servicenow_sysid = fields.Str()
    ssh_fingerprint = fields.Str()
    bios_uuid = fields.Str()
    netbios_name = fields.Str()
    operating_systems = fields.Str()
    tenable_agent_id = fields.Str()
    tenable_network_id = fields.Str()
    authenticated = fields.Bool()
    vulnerabilities = fields.List(fields.Nested(VulnerabilityObjectSchema))


class VulnerabilitySchema(Schema):
    '''
    Schema to validate Vulnerabilities API
    '''
    vendor = fields.Str(required=True)
    product = fields.Str(required=True)
    data_type = fields.Str(required=True)
    source = fields.Str(required=True)
    assets = fields.List(fields.Nested(AssetObjectSchema))
    coverage = fields.List(fields.Str())


# validate_schema decorator
schema = VulnerabilitySchema()
data = {'vendor': 'tenable',
        'product': 'tenable.sc',
        'data_type': 'vm',
        'source':
        '75c6c4c3-1626-4b57-9095-71b58ff8999e: \
        e9b89d18-87cc-4fd5-8e6f-27a1d24fa2ac0',
        'assets': [{
            'network_interfaces': [{
                'ipv4': ['192.0.2.57', '192.0.2.177']
            }],
            'hostname': 'windsmb.server.example.com',
            'bios_uuid': '9c60da51-762a-4b9b-8504-411056c2f696',
            'netbios_name': 'JUPITER',
            'vulnerabilities': [{
                'tenable_plugin_id': '97737',
                'last_found': 1568086236,
                'output': 'Description: The remote Windows host \
                is missing a security update.'
            }]
        }]
        }
payload = schema.dump(schema.load(data))
print(payload)
